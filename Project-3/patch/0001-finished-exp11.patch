From ed2d0618e95fa243c35f2c62d9f35a192d843e20 Mon Sep 17 00:00:00 2001
From: symmetree <symmetree@163.com>
Date: Tue, 28 Oct 2025 16:52:43 +0800
Subject: [PATCH] finished exp11

---
 EX.v        | 24 ++++++++++++-----
 ID.v        | 75 +++++++++++++++++++++++++++++++++++++++++++----------
 MEM.v       | 73 ++++++++++++++++++++++++++++++++++++++++++++-------
 mycpu_top.v |  4 +--
 4 files changed, 144 insertions(+), 32 deletions(-)

diff --git a/EX.v b/EX.v
index 60eb68c..7712ca1 100644
--- a/EX.v
+++ b/EX.v
@@ -2,12 +2,12 @@ module EX(
         input   wire            clk,
         input   wire            rst,
         input   wire            MEM_allowin,
-        input   wire [188:0]    ID_to_EX_zip,
+        input   wire [195:0]    ID_to_EX_zip,
         output  wire            front_valid,
         output  wire [  4:0]    front_addr,
         output  wire [ 31:0]    front_data,
         output  wire            EX_allowin,
-        output  reg  [137:0]    EX_to_MEM_reg
+        output  reg  [144:0]    EX_to_MEM_reg
 );
 
 wire            valid;
@@ -16,9 +16,17 @@ wire [31:0]     IR;
 wire [31:0]     src1;
 wire [31:0]     src2;
 wire [11:0]     aluop;
-wire [40:0]     EX_to_MEM_zip;
+wire [47:0]     EX_to_MEM_zip;
 
 wire            inst_ld_w;
+wire            inst_ld_b;
+wire            inst_ld_h;
+wire            inst_ld_bu;
+wire            inst_ld_hu;
+wire            inst_st_b;
+wire            inst_st_h;
+wire            inst_st_w;
+
 wire            inst_mul;
 wire            inst_mulh;
 wire            inst_mulhu;
@@ -32,7 +40,7 @@ wire            gr_we;
 wire [31:0]     rkd_value;
 wire [ 4:0]     rf_waddr;
 
-assign front_valid = ~inst_ld_w & gr_we;
+assign front_valid = ~res_from_mem & gr_we;
 assign front_addr = rf_waddr;
 assign front_data = alu_result;
 
@@ -44,7 +52,9 @@ assign  {
 } = ID_to_EX_zip;
 
 assign {
-        inst_ld_w, mem_we, res_from_mem, gr_we, rkd_value, rf_waddr
+        inst_ld_b, inst_ld_bu, inst_ld_h, inst_ld_hu, inst_ld_w, 
+        inst_st_b, inst_st_h, inst_st_w,
+        mem_we, res_from_mem, gr_we, rkd_value, rf_waddr
 } = EX_to_MEM_zip;
 
 
@@ -195,13 +205,13 @@ end
 
 always @(posedge clk) begin
         if (rst) begin
-                EX_to_MEM_reg <= 138'b0;
+                EX_to_MEM_reg <= 145'b0;
         end
         else if (readygo & MEM_allowin) begin
                 EX_to_MEM_reg <= {valid & ~rst, pc, IR, EX_to_MEM_zip, compute_result};
         end
         else if (~readygo & MEM_allowin) begin
-                EX_to_MEM_reg <= 138'b0;
+                EX_to_MEM_reg <= 145'b0;
         end
         else begin
                 EX_to_MEM_reg <= EX_to_MEM_reg;
diff --git a/ID.v b/ID.v
index 2bd5529..0ea4335 100644
--- a/ID.v
+++ b/ID.v
@@ -23,7 +23,7 @@ module ID(
         output  wire [  4:0]    rf_raddr2,
         output  wire            flush,
         output  wire [ 31:0]    pc_real,
-        output  reg  [188:0]    ID_to_EX_reg
+        output  reg  [195:0]    ID_to_EX_reg
 );
 
 reg  [31:0]     last_pc;
@@ -82,6 +82,8 @@ wire [ 4:0]     dest;
 wire [31:0]     rj_value;
 wire [31:0]     rkd_value;
 wire            rj_eq_rd;
+wire            rj_lt_rd;
+wire            rj_lt_rd_u;
 wire [31:0]     imm;
 wire [31:0]     br_offs;
 wire [31:0]     jirl_offs;
@@ -143,6 +145,18 @@ wire            inst_mod;
 wire            inst_divu;
 wire            inst_modu;
 
+wire            inst_blt;
+wire            inst_bge;
+wire            inst_bltu;
+wire            inst_bgeu;
+
+wire            inst_ld_b;
+wire            inst_ld_h;
+wire            inst_ld_bu;
+wire            inst_ld_hu;
+wire            inst_st_b;
+wire            inst_st_h;
+
 wire            need_ui5;
 wire            need_ui12;
 wire            need_si12;
@@ -183,8 +197,7 @@ assign  inst_slli_w     = op_31_26_d[6'h00] & op_25_22_d[4'h1] & op_21_20_d[2'h0
 assign  inst_srli_w     = op_31_26_d[6'h00] & op_25_22_d[4'h1] & op_21_20_d[2'h0] & op_19_15_d[5'h09];
 assign  inst_srai_w     = op_31_26_d[6'h00] & op_25_22_d[4'h1] & op_21_20_d[2'h0] & op_19_15_d[5'h11];
 assign  inst_addi_w     = op_31_26_d[6'h00] & op_25_22_d[4'ha];
-assign  inst_ld_w       = op_31_26_d[6'h0a] & op_25_22_d[4'h2];
-assign  inst_st_w       = op_31_26_d[6'h0a] & op_25_22_d[4'h6];
+
 assign  inst_jirl       = op_31_26_d[6'h13];
 assign  inst_b          = op_31_26_d[6'h14];
 assign  inst_bl         = op_31_26_d[6'h15];
@@ -210,7 +223,22 @@ assign  inst_mod        = op_31_26_d[6'h00] & op_25_22_d[4'h0] & op_21_20_d[2'h2
 assign  inst_divu       = op_31_26_d[6'h00] & op_25_22_d[4'h0] & op_21_20_d[2'h2] & op_19_15_d[5'h02];
 assign  inst_modu       = op_31_26_d[6'h00] & op_25_22_d[4'h0] & op_21_20_d[2'h2] & op_19_15_d[5'h03];
 
+assign  inst_blt        = op_31_26_d[6'h18];
+assign  inst_bge        = op_31_26_d[6'h19];
+assign  inst_bltu       = op_31_26_d[6'h1a];
+assign  inst_bgeu       = op_31_26_d[6'h1b];
+
+assign  inst_ld_b       = op_31_26_d[6'h0a] & op_25_22_d[4'h0];
+assign  inst_ld_h       = op_31_26_d[6'h0a] & op_25_22_d[4'h1];
+assign  inst_ld_w       = op_31_26_d[6'h0a] & op_25_22_d[4'h2];
+assign  inst_st_b       = op_31_26_d[6'h0a] & op_25_22_d[4'h4];
+assign  inst_st_h       = op_31_26_d[6'h0a] & op_25_22_d[4'h5];
+assign  inst_st_w       = op_31_26_d[6'h0a] & op_25_22_d[4'h6];
+assign  inst_ld_bu      = op_31_26_d[6'h0a] & op_25_22_d[4'h8];
+assign  inst_ld_hu      = op_31_26_d[6'h0a] & op_25_22_d[4'h9];
+
 assign  alu_op[ 0]      = inst_add_w | inst_addi_w | inst_ld_w | inst_st_w
+                         | inst_ld_b | inst_ld_bu |inst_ld_h | inst_ld_hu | inst_st_b | inst_st_h
                          | inst_jirl | inst_bl | inst_pcaddu12i;
 assign  alu_op[ 1]      = inst_sub_w;
 assign  alu_op[ 2]      = inst_slt | inst_slti;
@@ -226,7 +254,9 @@ assign  alu_op[11]      = inst_lu12i_w;
 
 assign  need_ui5        =  inst_slli_w | inst_srli_w | inst_srai_w;
 assign  need_ui12       =  inst_andi | inst_ori | inst_xori;//
-assign  need_si12       =  inst_addi_w | inst_ld_w | inst_st_w | inst_slti | inst_sltui;
+assign  need_si12       =  inst_addi_w | inst_ld_w | inst_st_w 
+                         | inst_ld_b | inst_ld_bu |inst_ld_h | inst_ld_hu | inst_st_b | inst_st_h
+                         | inst_slti | inst_sltui;
 assign  need_si16       =  inst_jirl | inst_beq | inst_bne;
 assign  need_si20       =  inst_lu12i_w | inst_pcaddu12i;
 assign  need_si26       =  inst_b | inst_bl;
@@ -243,7 +273,8 @@ assign  br_offs         = need_si26 ? {{ 4{i26[25]}}, i26[25:0], 2'b0} :
 
 assign  jirl_offs       = {{14{i16[15]}}, i16[15:0], 2'b0};
 
-assign  src_reg_is_rd   = inst_beq | inst_bne | inst_st_w;
+assign  src_reg_is_rd   = inst_beq | inst_bne | inst_st_w | inst_st_b | inst_st_h |
+                          inst_blt | inst_bge | inst_bltu | inst_bgeu;
 
 assign  src1_is_pc      = inst_jirl | inst_bl | inst_pcaddu12i;
 
@@ -253,6 +284,12 @@ assign  src2_is_imm     = inst_slli_w |
                           inst_addi_w |
                           inst_ld_w   |
                           inst_st_w   |
+                          inst_ld_b   |
+                          inst_ld_bu  |
+                          inst_ld_h   |
+                          inst_ld_hu  |
+                          inst_st_b   |
+                          inst_st_h   |
                           inst_lu12i_w|
                           inst_jirl   |
                           inst_bl     |
@@ -263,10 +300,11 @@ assign  src2_is_imm     = inst_slli_w |
                           inst_xori   |
                           inst_pcaddu12i ;
 
-assign  res_from_mem    = inst_ld_w;
+assign  res_from_mem    = inst_ld_w | inst_ld_b | inst_ld_bu |inst_ld_h | inst_ld_hu;
 assign  dst_is_r1       = inst_bl;
-assign  gr_we           = ~inst_st_w & ~inst_beq & ~inst_bne & ~inst_b;
-assign  mem_we          = inst_st_w;
+assign  gr_we           = ~inst_st_w & ~inst_st_b & ~inst_st_h &
+                          ~inst_beq & ~inst_bne & ~inst_b & ~inst_blt & ~inst_bge & ~inst_bltu & ~inst_bgeu;
+assign  mem_we          = inst_st_w | inst_st_b | inst_st_h;
 assign  dest            = dst_is_r1 ? 5'd1 : rd;
 
 assign  rf_raddr1       = rj;
@@ -282,20 +320,26 @@ assign  rkd_value       = need_pause & (last_dest == rf_raddr2) ? last_load_data
                           rf_rdata2;
 
 assign  rj_eq_rd        = (rj_value == rkd_value);
+assign  rj_lt_rd        = (rj_value[31] != rkd_value[31]) ? rj_value[31] : (rj_value < rkd_value);
+assign  rj_lt_rd_u      = rj_value < rkd_value;
 assign  br_taken        = (   inst_beq  &&  rj_eq_rd
                            || inst_bne  && !rj_eq_rd
+                           || inst_blt  &&  rj_lt_rd
+                           || inst_bge  && !rj_lt_rd
+                           || inst_bltu &&  rj_lt_rd_u
+                           || inst_bgeu && !rj_lt_rd_u
                            || inst_jirl
                            || inst_bl
                            || inst_b
                           ) && valid;
-assign  br_target       = (inst_beq || inst_bne || inst_bl || inst_b) ? (pc + br_offs) :
+assign  br_target       = (inst_beq || inst_bne || inst_bl || inst_b || inst_blt || inst_bge || inst_bltu || inst_bgeu) ? (pc + br_offs) :
                                                    /*inst_jirl*/ (rj_value + jirl_offs);
 
 assign  flush           = ((br_taken ^ predict) | inst_jirl) & ~rst & valid;
 
 always @(posedge clk) begin
         if (rst) begin
-                ID_to_EX_reg <= 189'b0;
+                ID_to_EX_reg <= 196'b0;
         end
         else if (EX_allowin & readygo) begin
                 ID_to_EX_reg <= {
@@ -303,12 +347,15 @@ always @(posedge clk) begin
                         pc, inst,
                         src1_is_pc ? pc : rj_value,
                         src2_is_imm ? imm : rkd_value,
-                        alu_op, inst_ld_w, mem_we, res_from_mem, gr_we, rkd_value, dest,
+                        alu_op, 
+                        inst_ld_b, inst_ld_bu, inst_ld_h, inst_ld_hu, inst_ld_w, 
+                        inst_st_b, inst_st_h, inst_st_w, 
+                        mem_we, res_from_mem, gr_we, rkd_value, dest,
                         inst_mul, inst_mulh, inst_mulhu, inst_div, inst_mod, inst_divu, inst_modu
-                        };
+                };
         end
         else if (EX_allowin & ~readygo) begin
-                ID_to_EX_reg <= 189'b0;
+                ID_to_EX_reg <= 196'b0;
         end
         else begin
                 ID_to_EX_reg <= ID_to_EX_reg;
@@ -320,7 +367,7 @@ always @(posedge clk) begin
                 last_is_load <= 1'b0;
         end
         else if (EX_allowin & readygo) begin
-                last_is_load <= inst_ld_w;
+                last_is_load <= res_from_mem;
         end
         else begin
                 last_is_load <= last_is_load;
diff --git a/MEM.v b/MEM.v
index 25c0b81..86a71a0 100644
--- a/MEM.v
+++ b/MEM.v
@@ -6,7 +6,7 @@ module MEM(
         input   wire            data_ready,
         input   wire            data_valid,
         input   wire [ 31:0]    read_data,
-        input   wire [137:0]    EX_to_MEM_zip,
+        input   wire [144:0]    EX_to_MEM_zip,
 
         output  wire            front_valid,
         output  wire [  4:0]    front_addr,
@@ -26,7 +26,16 @@ module MEM(
 wire            valid;
 wire [31:0]     pc;
 wire [31:0]     IR;
+
 wire            inst_ld_w;
+wire            inst_ld_b;
+wire            inst_ld_h;
+wire            inst_ld_bu;
+wire            inst_ld_hu;
+wire            inst_st_b;
+wire            inst_st_h;
+wire            inst_st_w;
+
 wire            mem_we;
 wire            res_from_mem;
 wire            gr_we;
@@ -34,13 +43,21 @@ wire [31:0]     rkd_value;
 wire [31:0]     alu_result;
 wire [ 4:0]     rf_waddr;
 wire [31:0]     rf_wdata;
+wire [31:0]     rf_wdata_LOAD;
+wire [31:0]     rf_wdata_ld_b;
+wire [31:0]     rf_wdata_ld_bu;
+wire [31:0]     rf_wdata_ld_h;
+wire [31:0]     rf_wdata_ld_hu;
+
+wire [3:0]      write_we_st_b;
+wire [3:0]      write_we_st_h;
 
 assign done_pc = pc;
-assign front_valid = ~inst_ld_w & gr_we;
+assign front_valid = ~res_from_mem & gr_we;
 assign front_addr = rf_waddr;
 assign front_data = alu_result;
 assign MEM_done = readygo;
-assign loaded_data = read_data;
+assign loaded_data = rf_wdata_LOAD;
 
 reg             readygo;
 
@@ -62,16 +79,54 @@ end
 assign MEM_allowin = ~valid | (readygo & WB_allowin);
 
 assign  {
-        valid, pc, IR, inst_ld_w, mem_we, res_from_mem, gr_we, rkd_value, rf_waddr, alu_result
+        valid, pc, IR, 
+        inst_ld_b, inst_ld_bu, inst_ld_h, inst_ld_hu, inst_ld_w, 
+        inst_st_b, inst_st_h, inst_st_w, 
+        mem_we, res_from_mem, gr_we, rkd_value, rf_waddr, alu_result
 } = EX_to_MEM_zip;
 
 
-assign rf_wdata = res_from_mem ? read_data : alu_result;
+assign rf_wdata_ld_b    = (write_addr[1:0]==2'b00)? {{24{read_data[7]}}, read_data[7:0]}:
+                          (write_addr[1:0]==2'b01)? {{24{read_data[15]}},read_data[15:8]}:
+			  (write_addr[1:0]==2'b10)? {{24{read_data[23]}},read_data[23:16]}:
+  			                            {{24{read_data[31]}},read_data[31:24]};
+
+assign rf_wdata_ld_bu   = (write_addr[1:0]==2'b00)? {24'b0, read_data[7:0]}:
+                          (write_addr[1:0]==2'b01)? {24'b0,read_data[15:8]}:
+			  (write_addr[1:0]==2'b10)? {24'b0,read_data[23:16]}:
+  			                            {24'b0,read_data[31:24]};
+
+assign rf_wdata_ld_h    = (write_addr[1])? {{16{read_data[31]}},read_data[31:16]}:
+				  	   {{16{read_data[15]}},read_data[15:0]};
+assign rf_wdata_ld_hu   = (write_addr[1])? {16'b0,read_data[31:16]}:
+				  	   {16'b0,read_data[15:0]};
+
+assign rf_wdata_LOAD    = inst_ld_b?  rf_wdata_ld_b : 
+                          inst_ld_bu? rf_wdata_ld_bu:
+                          inst_ld_h?  rf_wdata_ld_h :
+                          inst_ld_hu? rf_wdata_ld_hu:
+                          read_data;
+
+assign rf_wdata         = res_from_mem ? rf_wdata_LOAD : alu_result;
+
+assign write_en         = (mem_we | res_from_mem) & valid;
 
-assign write_en = (mem_we | inst_ld_w) & valid;
-assign write_we = {4{mem_we & valid}};
-assign write_addr = alu_result;
-assign write_data = rkd_value;
+assign write_we_st_b    = (write_addr[1:0]==2'b00)? 4'b0001:
+                          (write_addr[1:0]==2'b01)? 4'b0010:
+                          (write_addr[1:0]==2'b10)? 4'b0100:
+                          4'b1000;
+assign write_we_st_h    = (write_addr[1:0]==2'b00)? 4'b0011:
+                          4'b1100;                          
+assign write_we         = {4{valid}} & 
+                          (inst_st_b? {write_we_st_b}:
+                          inst_st_h? write_we_st_h:
+                          inst_st_w? 4'b1111:
+                          4'b0000);
+                  
+assign write_addr       = alu_result;
+assign write_data       = inst_st_b? {4{rkd_value[7:0]}}:
+                          inst_st_h? {2{rkd_value[15:0]}}:
+                          rkd_value;
 
 always @(posedge clk) begin
         if (rst) begin
diff --git a/mycpu_top.v b/mycpu_top.v
index 11bc21e..e7d8fd8 100644
--- a/mycpu_top.v
+++ b/mycpu_top.v
@@ -42,8 +42,8 @@ assign data_valid = 1'b1;
 
 // internal pipeline zipes
 wire [64:0]  IF_to_ID_reg;
-wire [188:0] ID_to_EX_reg;
-wire [137:0] EX_to_MEM_reg;
+wire [195:0] ID_to_EX_reg;
+wire [144:0] EX_to_MEM_reg;
 wire [102:0] MEM_to_WB_reg;
 
 // IF <-> ID signals
-- 
2.51.0

